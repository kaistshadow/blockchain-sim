
set(CARGO_NAME "hello")

set(LIB_FILE "${CMAKE_CURRENT_BINARY_DIR}/${LIB_BUILD_TYPE}/${CMAKE_STATIC_LIBRARY_PREFIX}${CARGO_NAME}${CMAKE_SHARED_LIBRARY_SUFFIX}")
set(LIB_COMPILED_FILE "${CMAKE_CURRENT_BINARY_DIR}/${LIB_BUILD_TYPE}/${CARGO_NAME}")

set(CARGO_TARGET_DIR ${CMAKE_CURRENT_BINARY_DIR})
set(CARGO_ENV_COMMAND ${CMAKE_COMMAND} -E env "CARGO_TARGET_DIR=${CARGO_TARGET_DIR}")

set(CARGO_ARGS "build")
file(GLOB_RECURSE LIB_SOURCES "*.rs")

### compilation 
add_custom_command(
  OUTPUT ${LIB_FILE}
  COMMAND ${CARGO_ENV_COMMAND} ${CARGO_EXECUTABLE} ARGS ${CARGO_ARGS}
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
  DEPENDS ${LIB_SOURCES}
  COMMENT "running cargo")

add_custom_target(${CARGO_NAME}_target ALL DEPENDS ${LIB_FILE})

### add installation 
install(PROGRAMS ${LIB_FILE} DESTINATION plugins)  

### add test
add_test(NAME BLEEP-regtest-rust-hello
  COMMAND python test.py --noserver rust/1_hello/rust_hello.xml
  WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/../..")
